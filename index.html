<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mathematisches</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=IM+Fell+English:ital@0;1&display=swap"
    rel="stylesheet" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0a0a0a;
      --surface: #111111;
      --border: rgba(255, 255, 255, 0.1);
      --text: #e8e8e8;
      --muted: #666;
      --accent: #ffffff;
      --canvas-bg: #050505;
      --portrait-bg: #1a1a1a;
      --transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    html.light {
      --bg: #f5f2ee;
      --surface: #ede9e3;
      --border: rgba(0, 0, 0, 0.1);
      --text: #1a1a1a;
      --muted: #999;
      --accent: #1a1a1a;
      --canvas-bg: #faf8f5;
      --portrait-bg: #ddd9d3;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Caveat', cursive;
      min-height: 100vh;
      overflow-x: hidden;
      transition: var(--transition);
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 999;
      opacity: 0.4;
    }

    /* ── INTRO OVERLAY ── */
    .intro-overlay {
      position: fixed;
      inset: 0;
      background: #0a0a0a;
      z-index: 99999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .intro-title {
      font-family: 'Caveat', cursive;
      font-size: clamp(48px, 8vw, 96px);
      font-weight: 700;
      letter-spacing: -1px;
      will-change: transform;
    }

    .intro-title .letter {
      display: inline-block;
      color: rgba(255, 255, 255, 0.35);
    }

    .hero {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 24px 40px;
    }

    .title-block {
      text-align: center;
      margin-bottom: 40px;
      opacity: 0;
    }

    .title-block.visible {
      animation: fadeDown 0.6s ease forwards;
    }

    .title-block h1 {
      font-size: clamp(48px, 8vw, 96px);
      font-weight: 700;
      letter-spacing: -1px;
      line-height: 1;
      color: var(--accent);
      display: inline-block;
    }

    .title-block h1::after {
      content: '';
      display: block;
      height: 2px;
      background: var(--accent);
      margin-top: 6px;
      transform-origin: left;
      animation: lineGrow 1s ease 0.2s both;
    }

    .title-block p {
      margin-top: 12px;
      font-size: 18px;
      color: var(--muted);
      font-style: italic;
      font-family: 'IM Fell English', serif;
    }

    .page-content {
      opacity: 0;
      transition: opacity 0.8s ease;
    }

    .page-content.visible {
      opacity: 1;
    }

    .controls-area {
      width: 100%;
      max-width: 960px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 16px;
      animation: fadeUp 0.8s ease 0.2s both;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }

    .control-label {
      font-size: 20px;
      color: var(--muted);
      white-space: nowrap;
    }

    select,
    input[type="number"] {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'Caveat', cursive;
      font-size: 20px;
      padding: 8px 16px;
      border-radius: 8px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    select {
      appearance: none;
      padding-right: 36px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    select:hover,
    input[type="number"]:hover,
    select:focus,
    input[type="number"]:focus {
      border-color: rgba(255, 255, 255, 0.35);
    }

    input[type="number"] {
      width: 110px;
    }

    .color-swatches {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .swatch {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.15s, border-color 0.15s;
    }

    .swatch:hover {
      transform: scale(1.2);
    }

    .swatch.active {
      border-color: white;
      transform: scale(1.15);
    }

    .presets {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .preset-label {
      font-size: 16px;
      color: var(--muted);
      font-style: italic;
      font-family: 'IM Fell English', serif;
    }

    .preset-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-family: 'Caveat', cursive;
      font-size: 16px;
      padding: 4px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .action-btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      font-family: 'Caveat', cursive;
      font-size: 20px;
      font-weight: 600;
      padding: 9px 28px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
      font-size: 22px;
      font-weight: 700;
    }

    .btn-primary:hover {
      box-shadow: 0 6px 24px rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: transparent;
      color: var(--muted);
    }

    .btn-secondary:hover {
      border-color: rgba(255, 255, 255, 0.3);
      color: var(--text);
    }

    .btn-danger {
      background: transparent;
      color: #ff5555;
      border-color: rgba(255, 85, 85, 0.3);
    }

    .btn-danger:hover {
      background: rgba(255, 85, 85, 0.08);
      border-color: #ff5555;
    }

    .btn-surprise {
      background: transparent;
      color: #aaa;
      border-color: var(--border);
      font-size: 18px;
    }

    .btn-surprise:hover {
      color: var(--text);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .canvas-wrapper {
      width: 100%;
      max-width: 960px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--canvas-bg);
      position: relative;
      margin-top: 16px;
      animation: fadeUp 0.8s ease 0.4s both;
    }

    canvas {
      display: block;
      width: 100%;
      height: 500px;
    }

    .canvas-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .canvas-idle-msg {
      color: var(--muted);
      font-size: 20px;
      font-style: italic;
      font-family: 'IM Fell English', serif;
      transition: opacity 0.4s;
    }

    .canvas-idle-msg.hidden {
      opacity: 0;
    }

    .canvas-status {
      position: absolute;
      bottom: 12px;
      right: 16px;
      font-size: 14px;
      color: var(--muted);
      font-family: 'IM Fell English', serif;
      font-style: italic;
    }

    .canvas-counter {
      position: absolute;
      bottom: 12px;
      left: 16px;
      font-size: 14px;
      color: var(--muted);
      font-family: 'IM Fell English', serif;
      font-style: italic;
    }

    .seq-info {
      width: 100%;
      max-width: 960px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 20px;
      margin-top: 14px;
      animation: fadeUp 0.5s ease both;
    }

    .seq-info h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--accent);
    }

    .seq-info p {
      font-size: 16px;
      color: #999;
      font-family: 'IM Fell English', serif;
      font-style: italic;
      line-height: 1.6;
    }

    .scroll-hint {
      margin-top: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 16px;
      font-style: italic;
      font-family: 'IM Fell English', serif;
      animation: fadeUp 1s ease 1s both;
    }

    .scroll-arrow {
      width: 1px;
      height: 40px;
      background: linear-gradient(to bottom, var(--muted), transparent);
      animation: scrollPulse 2s ease-in-out infinite;
    }

    .context-section {
      max-width: 960px;
      margin: 0 auto 80px;
      padding: 0 24px;
    }

    .context-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 40px;
      align-items: center;
      background: var(--surface);
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.7s ease, transform 0.7s ease;
    }

    .context-card.reverse {
      grid-template-columns: 1fr 200px;
    }

    .context-card.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .context-card h2 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--accent);
    }

    .context-card p {
      font-size: 18px;
      line-height: 1.7;
      color: #aaa;
      font-family: 'IM Fell English', serif;
    }

    .portrait-placeholder {
      width: 100%;
      aspect-ratio: 3/4;
      border-radius: 8px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--portrait-bg);
      color: var(--muted);
      font-size: 15px;
      text-align: center;
      font-family: 'IM Fell English', serif;
      font-style: italic;
      padding: 12px;
      line-height: 1.6;
    }

    .context-card.reverse .portrait-placeholder {
      grid-column: 2;
      grid-row: 1;
    }

    .context-card.reverse .text-block {
      grid-column: 1;
      grid-row: 1;
    }

    .section-divider {
      max-width: 960px;
      margin: 0 auto 80px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .section-divider span {
      color: var(--muted);
      font-size: 18px;
      white-space: nowrap;
      font-style: italic;
      font-family: 'IM Fell English', serif;
    }

    .section-divider::before,
    .section-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    footer {
      text-align: center;
      padding: 40px 24px;
      color: var(--muted);
      font-size: 16px;
      border-top: 1px solid var(--border);
      font-family: 'IM Fell English', serif;
      font-style: italic;
    }

    @media (max-width: 640px) {
      .hero {
        padding: 40px 16px 32px;
      }

      canvas {
        height: 320px;
      }

      .context-card {
        grid-template-columns: 1fr !important;
        padding: 24px;
        gap: 20px;
      }

      .context-card.reverse .portrait-placeholder {
        grid-column: 1;
        grid-row: 2;
      }

      .context-card.reverse .text-block {
        grid-column: 1;
        grid-row: 1;
      }

      .portrait-placeholder {
        aspect-ratio: 2/1;
      }

      img.portrait-placeholder {
        aspect-ratio: unset;
        height: 420px;
        width: 100%;
        object-position: center top;
      }

      .btn {
        padding: 8px 18px;
        font-size: 18px;
      }
    }

    @keyframes fadeDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes lineGrow {
      from {
        transform: scaleX(0);
      }

      to {
        transform: scaleX(1);
      }
    }

    @keyframes scrollPulse {

      0%,
      100% {
        opacity: 0.3;
      }

      50% {
        opacity: 1;
      }
    }

    /* ── SWATCH PICKER ── */
    .swatch-picker {
      background: var(--surface) !important;
      border: 1px dashed var(--muted) !important;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      color: var(--muted);
      transition: all 0.2s;
    }

    .swatch-picker:hover {
      border-color: var(--text) !important;
      color: var(--text);
    }

    .swatch-picker.active {
      border-color: white !important;
    }

    .custom-swatch {
      position: relative;
    }

    .custom-swatch::after {
      content: '×';
      position: absolute;
      top: -5px;
      right: -5px;
      width: 13px;
      height: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      line-height: 1;
      color: white;
      background: #333;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
    }

    .custom-swatch:hover::after {
      opacity: 1;
    }

    .picker-apply {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 14px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
    }

    .picker-apply:hover {
      color: var(--text);
      border-color: var(--text);
    }

    /* ── FOOTER LINKS ── */
    .footer-links {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .footer-link {
      background: none;
      border: none;
      color: var(--muted);
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 15px;
      cursor: pointer;
      transition: color 0.2s;
      text-decoration: underline;
      text-underline-offset: 3px;
      text-decoration-color: transparent;
    }

    .footer-link:hover {
      color: var(--text);
      text-decoration-color: var(--muted);
    }

    .footer-dot {
      color: var(--muted);
      font-size: 13px;
    }

    /* ── MODAL ── */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .modal-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 40px;
      max-width: 560px;
      width: 100%;
      position: relative;
      transform: translateY(20px);
      transition: transform 0.25s ease;
    }

    .modal-backdrop.open .modal {
      transform: translateY(0);
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      transition: color 0.2s;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-title {
      font-family: 'Caveat', cursive;
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
    }

    .modal-body {
      font-family: 'IM Fell English', serif;
      font-size: 17px;
      line-height: 1.75;
      color: #aaa;
      font-style: italic;
    }

    .modal-body p+p {
      margin-top: 12px;
    }

    /* ── HOW IT WORKS ── */
    .hiw-section {
      max-width: 960px;
      margin: 0 auto 80px;
      padding: 0 24px;
    }

    .hiw-section h2 {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 32px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.7s ease, transform 0.7s ease;
    }

    .hiw-section h2.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .hiw-steps {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 640px) {
      .hiw-steps {
        grid-template-columns: 1fr;
      }
    }

    .hiw-step {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      opacity: 0;
      transform: translateY(24px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .hiw-step.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .hiw-step-num {
      font-size: 13px;
      color: var(--muted);
      font-family: 'IM Fell English', serif;
      font-style: italic;
      margin-bottom: 10px;
    }

    .hiw-step h3 {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 10px;
    }

    .hiw-step p {
      font-size: 16px;
      color: #999;
      font-family: 'IM Fell English', serif;
      font-style: italic;
      line-height: 1.65;
      margin-bottom: 16px;
    }

    .hiw-step svg {
      display: block;
      width: 100%;
    }

    /* ── SEQUENCES SECTION ── */
    .seq-section {
      max-width: 960px;
      margin: 0 auto 80px;
      padding: 0 24px;
    }

    .seq-section h2 {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 32px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.7s ease, transform 0.7s ease;
    }

    .seq-section h2.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .seq-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    @media (max-width: 700px) {
      .seq-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 440px) {
      .seq-grid {
        grid-template-columns: 1fr;
      }
    }

    .seq-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      opacity: 0;
      transform: translateY(24px);
      transition: opacity 0.6s ease, transform 0.6s ease;
      cursor: pointer;
    }

    .seq-card:hover {
      border-color: rgba(255, 255, 255, 0.25);
    }

    .seq-card.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .seq-card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .seq-card-desc {
      font-size: 14px;
      color: var(--muted);
      font-family: 'IM Fell English', serif;
      font-style: italic;
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .seq-card svg {
      display: block;
      width: 100%;
      border-radius: 6px;
    }

    .fullscreen-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 18px;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
    }

    .fullscreen-btn:hover {
      color: var(--text);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .canvas-wrapper:fullscreen,
    .canvas-wrapper:-webkit-full-screen {
      background: var(--canvas-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0;
      max-width: 100%;
    }

    .canvas-wrapper:fullscreen canvas,
    .canvas-wrapper:-webkit-full-screen canvas {
      width: 100vw !important;
      height: 100vh !important;
    }

    /* ── THEME TOGGLE ── */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 14px;
      color: var(--muted);
      font-family: 'IM Fell English', serif;
      font-style: italic;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.02em;
    }

    .theme-toggle:hover {
      color: var(--text);
      border-color: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body>

  <!-- INTRO OVERLAY -->
  <div class="intro-overlay" id="introOverlay">
    <div class="intro-title" id="introTitle"></div>
  </div>

  <div class="page-content" id="pageContent">
    <section class="hero">
      <div class="title-block" id="titleBlock">
        <h1 id="realTitle" style="visibility:hidden">Mathematisches</h1>
        <p id="titleSubtitle" style="opacity:0; transition: opacity 0.6s ease;">Fractals from bits. Feed a number
          sequence, watch geometry emerge.</p>
      </div>

      <!-- Theme toggle -->
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">light</button>

      <div class="controls-area">
        <!-- Row 1: sequence + limit + presets -->
        <div class="controls-row">
          <span class="control-label">sequence</span>
          <select id="sequenceSelect" onchange="updateSeqInfo()">
            <option value="default">Non-negative integers</option>
            <option value="primes">Prime numbers</option>
            <option value="fibonacci">Fibonacci numbers</option>
            <option value="evens">Even numbers</option>
            <option value="odds">Odd numbers</option>
            <option value="palindromes">Binary palindromes</option>
          </select>
          <span class="control-label">limit =</span>
          <input type="number" id="limitInput" value="4096" min="64" max="65536" />
          <div class="presets">
            <span class="preset-label">try →</span>
            <button class="preset-btn" onclick="setLimit(512)">512</button>
            <button class="preset-btn" onclick="setLimit(1024)">1024</button>
            <button class="preset-btn" onclick="setLimit(4096)">4096</button>
            <button class="preset-btn" onclick="setLimit(16384)">16384</button>
            <button class="preset-btn" onclick="setLimit(65536)">65536</button>
          </div>
        </div>

        <!-- Row 2: speed + color -->
        <div class="controls-row">
          <span class="control-label">speed</span>
          <select id="speedSelect">
            <option value="slow">slow</option>
            <option value="medium" selected>medium</option>
            <option value="fast">fast</option>
            <option value="instant">instant</option>
          </select>
          <span class="control-label">color</span>
          <div class="color-swatches">
            <div class="swatch active" id="swatchAuto" style="background:#ffffff" data-color="#ffffff"
              data-dark-color="#1a1a1a" onclick="setColor(this)"></div>
            <div class="swatch" style="background:#7eb8f7" data-color="#7eb8f7" onclick="setColor(this)"></div>
            <div class="swatch" style="background:#f7c87e" data-color="#f7c87e" onclick="setColor(this)"></div>
            <div class="swatch" style="background:#7ef7a0" data-color="#7ef7a0" onclick="setColor(this)"></div>
            <div class="swatch" style="background:#f77eb8" data-color="#f77eb8" onclick="setColor(this)"></div>
            <div class="swatch" style="background:#c77ef7" data-color="#c77ef7" onclick="setColor(this)"></div>
            <!-- custom color picker -->
            <div class="swatch swatch-picker" id="swatchPicker" title="Custom color"
              onclick="document.getElementById('colorPickerInput').click()">＋</div>
            <input type="color" id="colorPickerInput" value="#ff6600" style="display:none"
              oninput="previewCustomColor(this.value)" onchange="previewCustomColor(this.value)" />
            <button class="picker-apply" id="pickerApply" onclick="applyCustomColor()" style="display:none"
              title="Apply this color">✓</button>
          </div>
        </div>

        <!-- Row 3: action buttons -->
        <div class="action-btns">
          <button class="btn btn-primary" id="drawBtn" onclick="startDraw()">Draw</button>
          <button class="btn btn-danger" id="stopBtn" onclick="stopDraw()" disabled>Stop</button>
          <button class="btn btn-secondary" id="clearBtn" onclick="clearCanvas()">Clear</button>
          <button class="btn btn-secondary" id="downloadBtn" onclick="downloadPNG()" disabled>Download PNG</button>
          <button class="btn btn-surprise" onclick="surpriseMe()">✦ Surprise me</button>
        </div>
      </div>

      <!-- Sequence info -->
      <div class="seq-info" id="seqInfo">
        <h3 id="seqInfoTitle">Non-negative integers</h3>
        <p id="seqInfoText">The classic Thue-Morse walk. Every integer from 0 to your limit is checked for binary
          parity. At 65,536 steps this traces the complete Koch snowflake — a fractal with infinite perimeter but finite
          area, emergent from nothing but bit counting.</p>
      </div>

      <!-- Canvas -->
      <div class="canvas-wrapper">
        <canvas id="fractalCanvas"></canvas>
        <div class="canvas-overlay">
          <div class="canvas-idle-msg" id="idleMsg">select a sequence and press Draw</div>
        </div>
        <div class="canvas-counter" id="canvasCounter"></div>
        <div class="canvas-status" id="canvasStatus"></div>
        <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Fullscreen">⛶</button>
      </div>

      <div class="scroll-hint">
        <span>scroll to learn more</span>
        <div class="scroll-arrow"></div>
      </div>
    </section>

    <!-- HOW IT WORKS -->
    <div class="section-divider"><span>how it works</span></div>
    <div class="hiw-section" id="hiwSection">
      <div class="hiw-steps">

        <!-- Step 1: Binary -->
        <div class="hiw-step" id="hiwStep1">
          <div class="hiw-step-num">step 01</div>
          <h3>Pick a number</h3>
          <p>Every integer has a binary representation — a string of 1s and 0s. Count how many 1-bits it contains.</p>
          <svg viewBox="0 0 280 110" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="280" height="110" fill="none" />
            <!-- number -->
            <text x="20" y="38" font-family="Caveat, cursive" font-size="28" fill="currentColor" opacity="0.9">n =
              13</text>
            <!-- arrow -->
            <text x="20" y="65" font-family="IM Fell English, serif" font-size="14" fill="currentColor" opacity="0.5"
              font-style="italic">binary</text>
            <line x1="20" y1="72" x2="260" y2="72" stroke="currentColor" stroke-opacity="0.15" stroke-width="1" />
            <!-- bits with highlights -->
            <rect x="20" y="78" width="22" height="22" rx="4" fill="currentColor" fill-opacity="0.15"
              stroke="currentColor" stroke-opacity="0.3" stroke-width="1" />
            <text x="31" y="94" font-family="Caveat, cursive" font-size="16" fill="currentColor" text-anchor="middle"
              opacity="0.9">1</text>
            <rect x="48" y="78" width="22" height="22" rx="4" fill="none" stroke="currentColor" stroke-opacity="0.2"
              stroke-width="1" />
            <text x="59" y="94" font-family="Caveat, cursive" font-size="16" fill="currentColor" text-anchor="middle"
              opacity="0.4">1</text>
            <rect x="76" y="78" width="22" height="22" rx="4" fill="none" stroke="currentColor" stroke-opacity="0.2"
              stroke-width="1" />
            <text x="87" y="94" font-family="Caveat, cursive" font-size="16" fill="currentColor" text-anchor="middle"
              opacity="0.4">0</text>
            <rect x="104" y="78" width="22" height="22" rx="4" fill="currentColor" fill-opacity="0.15"
              stroke="currentColor" stroke-opacity="0.3" stroke-width="1" />
            <text x="115" y="94" font-family="Caveat, cursive" font-size="16" fill="currentColor" text-anchor="middle"
              opacity="0.9">1</text>
            <text x="150" y="94" font-family="IM Fell English, serif" font-size="13" fill="currentColor" opacity="0.5"
              font-style="italic">three 1s → odd</text>
          </svg>
        </div>

        <!-- Step 2: Parity -->
        <div class="hiw-step" id="hiwStep2">
          <div class="hiw-step-num">step 02</div>
          <h3>Check the parity</h3>
          <p>Even count of 1s → command F (forward). Odd count → command T (turn left 60°).</p>
          <svg viewBox="0 0 280 110" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="280" height="110" fill="none" />
            <rect x="20" y="15" width="100" height="38" rx="8" fill="currentColor" fill-opacity="0.08"
              stroke="currentColor" stroke-opacity="0.2" stroke-width="1" />
            <text x="70" y="30" font-family="Caveat, cursive" font-size="14" fill="currentColor" text-anchor="middle"
              opacity="0.5">even 1-bits</text>
            <text x="70" y="46" font-family="Caveat, cursive" font-size="22" fill="currentColor" text-anchor="middle"
              font-weight="700">F</text>
            <text x="70" y="68" font-family="IM Fell English, serif" font-size="13" fill="currentColor"
              text-anchor="middle" opacity="0.5" font-style="italic">step forward</text>
            <rect x="160" y="15" width="100" height="38" rx="8" fill="currentColor" fill-opacity="0.08"
              stroke="currentColor" stroke-opacity="0.2" stroke-width="1" />
            <text x="210" y="30" font-family="Caveat, cursive" font-size="14" fill="currentColor" text-anchor="middle"
              opacity="0.5">odd 1-bits</text>
            <text x="210" y="46" font-family="Caveat, cursive" font-size="22" fill="currentColor" text-anchor="middle"
              font-weight="700">T</text>
            <text x="210" y="68" font-family="IM Fell English, serif" font-size="13" fill="currentColor"
              text-anchor="middle" opacity="0.5" font-style="italic">turn left 60°</text>
            <!-- example row -->
            <text x="20" y="95" font-family="Caveat, cursive" font-size="14" fill="currentColor" opacity="0.4">0→F 1→T
              2→T 3→F 4→T 5→F 6→F 7→T</text>
          </svg>
        </div>

        <!-- Step 3: Turtle -->
        <div class="hiw-step" id="hiwStep3">
          <div class="hiw-step-num">step 03</div>
          <h3>Walk the turtle</h3>
          <p>A virtual turtle reads each command. F means walk one step. T means pivot 60° left. Every number leaves a
            mark.</p>
          <svg viewBox="0 0 280 110" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="280" height="110" fill="none" />
            <!-- turtle path -->
            <polyline points="20,85 60,85 80,50 120,50 140,85 180,85 200,50" stroke="currentColor" stroke-opacity="0.7"
              stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round" />
            <!-- dots at each point -->
            <circle cx="20" cy="85" r="3" fill="currentColor" opacity="0.4" />
            <circle cx="60" cy="85" r="3" fill="currentColor" opacity="0.4" />
            <circle cx="80" cy="50" r="3" fill="currentColor" opacity="0.4" />
            <circle cx="120" cy="50" r="3" fill="currentColor" opacity="0.4" />
            <circle cx="140" cy="85" r="3" fill="currentColor" opacity="0.4" />
            <circle cx="180" cy="85" r="3" fill="currentColor" opacity="0.4" />
            <circle cx="200" cy="50" r="5" fill="currentColor" opacity="0.9" />
            <!-- turtle indicator -->
            <text x="205" y="46" font-family="Caveat, cursive" font-size="12" fill="currentColor" opacity="0.5">←
              turtle</text>
            <!-- labels -->
            <text x="30" y="98" font-family="Caveat, cursive" font-size="12" fill="currentColor" opacity="0.35">F</text>
            <text x="67" y="70" font-family="Caveat, cursive" font-size="12" fill="currentColor" opacity="0.35">T</text>
            <text x="92" y="46" font-family="Caveat, cursive" font-size="12" fill="currentColor" opacity="0.35">F</text>
            <text x="127" y="70" font-family="Caveat, cursive" font-size="12" fill="currentColor"
              opacity="0.35">T</text>
            <text x="152" y="98" font-family="Caveat, cursive" font-size="12" fill="currentColor"
              opacity="0.35">F</text>
            <text x="187" y="70" font-family="Caveat, cursive" font-size="12" fill="currentColor"
              opacity="0.35">T</text>
          </svg>
        </div>

        <!-- Step 4: Fractal -->
        <div class="hiw-step" id="hiwStep4">
          <div class="hiw-step-num">step 04</div>
          <h3>Fractal emerges</h3>
          <p>At 65,536 steps, the complete Koch snowflake appears — infinite complexity from a single arithmetic rule.
          </p>
          <svg viewBox="0 0 280 110" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="280" height="110" fill="none" />
            <!-- simplified Koch-like curve -->
            <polyline
              points="10,80 36,80 44,66 52,80 78,80 86,66 78,52 86,38 94,52 120,52 128,66 120,80 146,80 154,66 162,80 188,80 196,66 188,52 196,38 204,52 212,38 220,24 228,38 236,52 244,38 252,24 260,38 268,52"
              stroke="currentColor" stroke-opacity="0.75" stroke-width="1.2" fill="none" stroke-linecap="round"
              stroke-linejoin="round" />
            <text x="20" y="105" font-family="IM Fell English, serif" font-size="13" fill="currentColor" opacity="0.4"
              font-style="italic">Koch snowflake — 65,536 commands</text>
          </svg>
        </div>

      </div>
    </div>

    <!-- SEQUENCES -->
    <div class="section-divider" id="sequencesAnchor"><span>sequences</span></div>
    <div class="seq-section">
      <div class="seq-grid">

        <div class="seq-card" id="seqCard1"
          onclick="document.getElementById('sequenceSelect').value='default'; updateSeqInfo(); window.scrollTo({top:0,behavior:'smooth'})">
          <div class="seq-card-title">Non-negative integers</div>
          <div class="seq-card-desc">The classic. Produces the Koch snowflake at 65,536.</div>
          <svg viewBox="0 0 200 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="80" fill="currentColor" fill-opacity="0.04" rx="6" />
            <polyline
              points="10,60 20,60 25,50 30,60 40,60 45,50 40,40 45,30 50,40 60,40 65,50 60,60 70,60 75,50 80,60 90,60 95,50 90,40 95,30 100,40 105,30 110,20 115,30 120,40 125,30 130,20 135,30 140,40 145,30 150,20 155,30 160,40 165,50 160,60 170,60 175,50 180,60 190,60"
              stroke="currentColor" stroke-opacity="0.7" stroke-width="1.2" fill="none" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </div>

        <div class="seq-card" id="seqCard2"
          onclick="document.getElementById('sequenceSelect').value='primes'; updateSeqInfo(); window.scrollTo({top:0,behavior:'smooth'})">
          <div class="seq-card-title">Prime numbers</div>
          <div class="seq-card-desc">Chaotic, angular. No pattern ever repeats.</div>
          <svg viewBox="0 0 200 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="80" fill="currentColor" fill-opacity="0.04" rx="6" />
            <polyline
              points="10,50 25,50 35,35 30,55 45,40 55,60 50,45 65,55 60,35 75,50 85,65 80,45 95,55 100,35 110,50 120,40 115,60 130,45 140,60 135,40 150,55 160,40 155,60 170,45 180,60 175,40 190,55"
              stroke="currentColor" stroke-opacity="0.7" stroke-width="1.2" fill="none" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </div>

        <div class="seq-card" id="seqCard3"
          onclick="document.getElementById('sequenceSelect').value='fibonacci'; updateSeqInfo(); window.scrollTo({top:0,behavior:'smooth'})">
          <div class="seq-card-title">Fibonacci</div>
          <div class="seq-card-desc">Sparse growth creates nested hexagonal loops.</div>
          <svg viewBox="0 0 200 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="80" fill="currentColor" fill-opacity="0.04" rx="6" />
            <polygon points="100,15 140,40 140,70 100,65 60,70 60,40" stroke="currentColor" stroke-opacity="0.6"
              stroke-width="1.2" fill="none" />
            <polygon points="100,28 122,40 122,58 100,55 78,58 78,40" stroke="currentColor" stroke-opacity="0.4"
              stroke-width="1" fill="none" />
            <polygon points="100,38 112,44 112,54 100,52 88,54 88,44" stroke="currentColor" stroke-opacity="0.25"
              stroke-width="0.8" fill="none" />
          </svg>
        </div>

        <div class="seq-card" id="seqCard4"
          onclick="document.getElementById('sequenceSelect').value='evens'; updateSeqInfo(); window.scrollTo({top:0,behavior:'smooth'})">
          <div class="seq-card-title">Even numbers</div>
          <div class="seq-card-desc">A sparser Koch — same fractal, wider steps.</div>
          <svg viewBox="0 0 200 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="80" fill="currentColor" fill-opacity="0.04" rx="6" />
            <polyline points="10,65 40,65 55,40 70,65 100,65 115,40 100,20 115,5 130,20 160,20 175,40 160,65 190,65"
              stroke="currentColor" stroke-opacity="0.7" stroke-width="1.2" fill="none" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </div>

        <div class="seq-card" id="seqCard5"
          onclick="document.getElementById('sequenceSelect').value='odds'; updateSeqInfo(); window.scrollTo({top:0,behavior:'smooth'})">
          <div class="seq-card-title">Odd numbers</div>
          <div class="seq-card-desc">The Koch curve's mirror image — same geometry, flipped.</div>
          <svg viewBox="0 0 200 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="80" fill="currentColor" fill-opacity="0.04" rx="6" />
            <polyline points="190,65 160,65 145,40 130,65 100,65 85,40 100,20 85,5 70,20 40,20 25,40 40,65 10,65"
              stroke="currentColor" stroke-opacity="0.7" stroke-width="1.2" fill="none" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </div>

        <div class="seq-card" id="seqCard6"
          onclick="document.getElementById('sequenceSelect').value='palindromes'; updateSeqInfo(); window.scrollTo({top:0,behavior:'smooth'})">
          <div class="seq-card-title">Binary palindromes</div>
          <div class="seq-card-desc">Long sweeping lines with small geometric knots.</div>
          <svg viewBox="0 0 200 80" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="80" fill="currentColor" fill-opacity="0.04" rx="6" />
            <polyline points="10,60 70,30 130,60 160,45 175,45 180,40 175,35 160,35 155,40 160,45" stroke="currentColor"
              stroke-opacity="0.7" stroke-width="1.2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
            <circle cx="70" cy="30" r="4" stroke="currentColor" stroke-opacity="0.5" stroke-width="1" fill="none" />
            <circle cx="130" cy="60" r="4" stroke="currentColor" stroke-opacity="0.5" stroke-width="1" fill="none" />
          </svg>
        </div>

      </div>
    </div>

    <div class="section-divider"><span>context</span></div>
    <div class="context-section">
      <div class="context-card" id="kochCard">
        <img src="assets/Helge_von_Koch.jpg" alt="Helge von Koch — Swedish mathematician, 1870–1924"
          class="portrait-placeholder" style="object-fit: cover; object-position: center top; padding: 0;" />
        <div class="text-block">
          <h2>Helge von Koch</h2>
          <p>In 1904, Swedish mathematician Helge von Koch introduced what we now call the Koch curve — one of the
            earliest known fractals. His goal was purely theoretical: construct a curve that is continuous everywhere
            but differentiable nowhere. A line so jagged that no matter how far you zoom in, it never becomes smooth. He
            had no idea this shape would later appear in coastlines, snowflakes, lightning bolts, and blood vessels.
            Koch was making a mathematical counter-example. He accidentally described nature.</p>
        </div>
      </div>
    </div>

    <div class="section-divider"><span>the sequence</span></div>
    <div class="context-section">
      <div class="context-card reverse" id="thueMorseCard">
        <div class="text-block">
          <h2>The Thue-Morse Sequence</h2>
          <p>Take any non-negative integer. Count the number of 1-bits in its binary representation. If that count is
            even, write 0. If odd, write 1. Do this for every integer from 0 onwards and you get: 0, 1, 1, 0, 1, 0, 0,
            1, 1, 0, 0, 1... — the Thue-Morse sequence, independently discovered by Axel Thue in 1906 and Marston Morse
            in 1921. Now interpret 0 as "step forward" and 1 as "turn left 60°" — and watch the Koch snowflake fractal
            draw itself, emergent and complete, from nothing but the parity of binary digits.</p>
        </div>
        <img src="assets/Axel_Thue.jpg" alt="Axel Thue — Norwegian mathematician, 1863–1922"
          class="portrait-placeholder" style="object-fit: cover; object-position: center top; padding: 0;" />
      </div>
    </div>

    <footer>
      built with bits and curiosity &nbsp;·&nbsp; Mathematisches
      <div class="footer-links">
        <button class="footer-link" onclick="openModal('about')">About</button>
      </div>
    </footer>

  </div><!-- end page-content -->

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal()">✕</button>
      <h2 class="modal-title" id="modalTitle"></h2>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const SEQ_INFO = {
      default: { title: 'Non-negative integers', text: 'The classic Thue-Morse walk. Every integer from 0 to your limit is checked for binary parity. At 65,536 steps this traces the complete Koch snowflake — a fractal with infinite perimeter but finite area, emergent from nothing but bit counting.' },
      primes: { title: 'Prime numbers', text: 'Only prime numbers are fed through the parity rule. Primes have no regular spacing, so the curve never settles into clean repetition. The result is chaotic and angular — like a circuit board or a city map seen from above.' },
      fibonacci: { title: 'Fibonacci numbers', text: 'Fibonacci numbers grow exponentially, so even large limits produce very few data points. The golden ratio hidden in Fibonacci spacing creates hexagonal loops — the curve orbits and returns, forming nested hexagons at different scales.' },
      evens: { title: 'Even numbers', text: 'Even numbers always end in 0 in binary — dropping all odd numbers creates a sparser version of the Thue-Morse sequence. The fractal structure is preserved but chunkier and more spaced-out. A mini Koch curve.' },
      odds: { title: 'Odd numbers', text: 'Odd numbers always end in 1 in binary, so their parity is always the inverse of the corresponding even number. Every F becomes T and every T becomes F — producing the Koch curve\'s mirror image.' },
      palindromes: { title: 'Binary palindromes', text: 'A binary palindrome reads the same forwards and backwards (e.g. 101, 1001, 10101). They are very sparse — even up to a million there are only hundreds. The result: long sweeping lines with small geometric knots where palindromes cluster.' }
    };

    function updateSeqInfo() {
      const val = document.getElementById('sequenceSelect').value;
      document.getElementById('seqInfoTitle').textContent = SEQ_INFO[val].title;
      document.getElementById('seqInfoText').textContent = SEQ_INFO[val].text;
    }

    let curveColor = '#ffffff';

    function setColor(el) {
      document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
      el.classList.add('active');
      const isLight = document.documentElement.classList.contains('light');
      curveColor = (isLight && el.dataset.darkColor) ? el.dataset.darkColor : el.dataset.color;
      // reset custom picker swatch back to +
      const picker = document.getElementById('swatchPicker');
      picker.style.background = '';
      picker.style.color = '';
      picker.textContent = '＋';
      document.getElementById('pickerApply').style.display = 'none';
      pendingColor = null;
    }

    let pendingColor = null;

    function previewCustomColor(val) {
      pendingColor = val;
      const picker = document.getElementById('swatchPicker');
      picker.style.background = val;
      picker.style.color = 'transparent';
      document.getElementById('pickerApply').style.display = 'flex';
    }

    function applyCustomColor() {
      if (!pendingColor) return;
      addCustomSwatch(pendingColor, true);
      const picker = document.getElementById('swatchPicker');
      picker.style.background = '';
      picker.style.color = '';
      picker.textContent = '＋';
      document.getElementById('pickerApply').style.display = 'none';
      pendingColor = null;
    }

    function addCustomSwatch(color, save = false) {
      const newSwatch = document.createElement('div');
      newSwatch.className = 'swatch custom-swatch';
      newSwatch.style.background = color;
      newSwatch.dataset.color = color;
      newSwatch.title = `${color} — click × to remove`;

      newSwatch.onclick = (e) => {
        const rect = newSwatch.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        // top-right zone (last 10px wide, first 10px tall)
        if (x > rect.width - 10 && y < 10) {
          removeCustomSwatch(newSwatch, color);
        } else {
          setColor(newSwatch);
        }
      };

      // right-click also removes
      newSwatch.oncontextmenu = (e) => {
        e.preventDefault();
        removeCustomSwatch(newSwatch, color);
      };

      const picker = document.getElementById('swatchPicker');
      picker.parentNode.insertBefore(newSwatch, picker);
      setColor(newSwatch);

      if (save) {
        const saved = JSON.parse(localStorage.getItem('customColors') || '[]');
        if (!saved.includes(color)) {
          saved.push(color);
          localStorage.setItem('customColors', JSON.stringify(saved));
        }
      }
    }

    function removeCustomSwatch(el, color) {
      // if it was active, fall back to first default swatch
      if (el.classList.contains('active')) {
        const firstDefault = document.querySelector('.swatch:not(.custom-swatch):not(.swatch-picker)');
        if (firstDefault) setColor(firstDefault);
      }
      el.remove();
      const saved = JSON.parse(localStorage.getItem('customColors') || '[]');
      localStorage.setItem('customColors', JSON.stringify(saved.filter(c => c !== color)));
    }

    // restore saved custom swatches on load
    (function restoreCustomColors() {
      const saved = JSON.parse(localStorage.getItem('customColors') || '[]');
      saved.forEach(color => addCustomSwatch(color, false));
    })();

    function setLimit(val) { document.getElementById('limitInput').value = val; }

    function surpriseMe() {
      const seqs = ['default', 'primes', 'fibonacci', 'evens', 'odds', 'palindromes'];
      const limits = [512, 1024, 2048, 4096, 8192, 16384];
      document.getElementById('sequenceSelect').value = seqs[Math.floor(Math.random() * seqs.length)];
      document.getElementById('limitInput').value = limits[Math.floor(Math.random() * limits.length)];
      updateSeqInfo();
      startDraw();
    }

    function getNumbers(seq, limit) {
      if (seq === 'default') { const a = []; for (let i = 0; i < limit; i++) a.push(i); return a; }
      if (seq === 'primes') {
        const p = [];
        for (let n = 2; n < limit; n++) {
          let ip = true;
          for (let i = 2; i <= Math.sqrt(n); i++) { if (n % i === 0) { ip = false; break; } }
          if (ip) p.push(n);
        }
        return p;
      }
      if (seq === 'fibonacci') { const f = []; let a = 0, b = 1; while (a < limit * 50) { f.push(a);[a, b] = [a + b, a]; } return f; }
      if (seq === 'evens') { const a = []; for (let i = 0; i < limit; i += 2) a.push(i); return a; }
      if (seq === 'odds') { const a = []; for (let i = 1; i < limit; i += 2) a.push(i); return a; }
      if (seq === 'palindromes') {
        const a = [];
        for (let n = 0; n < limit * 20; n++) { const b = n.toString(2); if (b === b.split('').reverse().join('')) a.push(n); }
        return a;
      }
      return [];
    }

    function generateCommands(numbers) {
      return numbers.map(n => {
        let c = 0, x = n; while (x) { c += x & 1; x >>= 1; }
        return c % 2 === 0 ? 'F' : 'T';
      });
    }

    function computePath(commands) {
      const pts = [{ x: 0, y: 0 }]; let x = 0, y = 0, angle = 0;
      for (const cmd of commands) {
        if (cmd === 'F') { x += Math.cos(angle * Math.PI / 180); y += Math.sin(angle * Math.PI / 180); pts.push({ x, y }); }
        else angle += 60;
      }
      return pts;
    }

    let animFrame = null, isDrawing = false;
    const BATCH = { slow: 1, medium: 8, fast: 40, instant: Infinity };

    function stopDraw() {
      if (animFrame) cancelAnimationFrame(animFrame);
      isDrawing = false;
      document.getElementById('drawBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('canvasStatus').textContent = 'stopped.';
    }

    function clearCanvas() {
      stopDraw();
      const canvas = document.getElementById('fractalCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById('canvasStatus').textContent = '';
      document.getElementById('canvasCounter').textContent = '';
      document.getElementById('idleMsg').classList.remove('hidden');
      document.getElementById('downloadBtn').disabled = true;
    }

    function downloadPNG() {
      const canvas = document.getElementById('fractalCanvas');
      // create a temp canvas with background filled
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const tempCtx = tempCanvas.getContext('2d');
      // fill background
      const isLight = document.documentElement.classList.contains('light');
      tempCtx.fillStyle = isLight ? '#faf8f5' : '#050505';
      tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
      // draw the fractal on top
      tempCtx.drawImage(canvas, 0, 0);
      const link = document.createElement('a');
      link.download = 'mathematisches.png';
      link.href = tempCanvas.toDataURL('image/png');
      link.click();
    }

    function startDraw() {
      if (animFrame) cancelAnimationFrame(animFrame);
      const limit = parseInt(document.getElementById('limitInput').value) || 4096;
      const seq = document.getElementById('sequenceSelect').value;
      const speed = document.getElementById('speedSelect').value;
      const drawBtn = document.getElementById('drawBtn');
      const stopBtn = document.getElementById('stopBtn');
      const status = document.getElementById('canvasStatus');
      const counter = document.getElementById('canvasCounter');

      drawBtn.disabled = true; stopBtn.disabled = false;
      document.getElementById('downloadBtn').disabled = true;
      document.getElementById('idleMsg').classList.add('hidden');
      status.textContent = 'computing...'; counter.textContent = '';

      setTimeout(() => {
        const numbers = getNumbers(seq, limit);
        const commands = generateCommands(numbers);
        const points = computePath(commands);

        if (points.length < 2) {
          status.textContent = 'not enough points.';
          drawBtn.disabled = false; stopBtn.disabled = true; return;
        }

        const xs = points.map(p => p.x), ys = points.map(p => p.y);
        const minX = Math.min(...xs), maxX = Math.max(...xs);
        const minY = Math.min(...ys), maxY = Math.max(...ys);
        const bw = Math.max(maxX - minX, 0.001), bh = Math.max(maxY - minY, 0.001);

        const canvas = document.getElementById('fractalCanvas');
        const dpr = window.devicePixelRatio || 1;
        const W = canvas.clientWidth, H = canvas.clientHeight;
        canvas.width = W * dpr; canvas.height = H * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        const pad = 48;
        const scale = Math.min((W - pad * 2) / bw, (H - pad * 2) / bh);
        const offX = (W - bw * scale) / 2 - minX * scale;
        const offY = (H - bh * scale) / 2 - minY * scale;

        ctx.clearRect(0, 0, W, H);
        ctx.strokeStyle = curveColor;
        ctx.lineWidth = Math.max(0.4, Math.min(1.5, 600 / points.length));
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';

        const batchSize = BATCH[speed];

        if (batchSize === Infinity) {
          ctx.beginPath();
          ctx.moveTo(points[0].x * scale + offX, points[0].y * scale + offY);
          for (let j = 1; j < points.length; j++) ctx.lineTo(points[j].x * scale + offX, points[j].y * scale + offY);
          ctx.stroke();
          status.textContent = `${numbers.length.toLocaleString()} numbers · ${commands.length.toLocaleString()} commands`;
          drawBtn.disabled = false; stopBtn.disabled = true;
          document.getElementById('downloadBtn').disabled = false;
          return;
        }

        let i = 1; isDrawing = true;

        function drawStep() {
          if (!isDrawing) return;
          const end = Math.min(i + batchSize, points.length);
          ctx.beginPath();
          ctx.moveTo(points[i - 1].x * scale + offX, points[i - 1].y * scale + offY);
          for (let j = i; j < end; j++) ctx.lineTo(points[j].x * scale + offX, points[j].y * scale + offY);
          ctx.stroke();
          i = end;
          const pct = Math.round(i / points.length * 100);
          status.textContent = `drawing... ${pct}%`;
          counter.textContent = `n = ${numbers[Math.min(i, numbers.length - 1)].toLocaleString()}`;

          if (i < points.length) {
            animFrame = requestAnimationFrame(drawStep);
          } else {
            isDrawing = false;
            status.textContent = `${numbers.length.toLocaleString()} numbers · ${commands.length.toLocaleString()} commands`;
            counter.textContent = '';
            drawBtn.disabled = false; stopBtn.disabled = true;
            document.getElementById('downloadBtn').disabled = false;
          }
        }
        animFrame = requestAnimationFrame(drawStep);
      }, 50);
    }

    // ── INTRO ANIMATION ──
    (function runIntro() {
      const target = 'Mathematisches';
      const introEl = document.getElementById('introTitle');
      const overlay = document.getElementById('introOverlay');
      const titleBlock = document.getElementById('titleBlock');
      const realTitle = document.getElementById('realTitle');
      const subtitle = document.getElementById('titleSubtitle');
      const pageContent = document.getElementById('pageContent');

      // build letter spans
      const spans = [];
      for (let i = 0; i < target.length; i++) {
        const span = document.createElement('span');
        span.className = 'letter';
        span.textContent = '0';
        span.style.color = 'rgba(255,255,255,0.35)';
        introEl.appendChild(span);
        spans.push(span);
      }

      const locked = new Array(target.length).fill(false);
      let lockIndex = 0;
      let frame = 0;

      const timer = setInterval(() => {
        frame++;

        for (let i = 0; i < target.length; i++) {
          if (locked[i]) continue;
          const bit = Math.random() > 0.5 ? '1' : '0';
          spans[i].textContent = bit;
          const proximity = Math.max(0, 1 - (lockIndex - i) * 0.15);
          const opacity = 0.2 + proximity * 0.6;
          spans[i].style.color = `rgba(255,255,255,${opacity})`;
        }

        if (frame % 3 === 0 && lockIndex < target.length) {
          spans[lockIndex].textContent = target[lockIndex];
          spans[lockIndex].style.color = '#ffffff';
          spans[lockIndex].style.textShadow = '0 0 30px rgba(255,255,255,1), 0 0 60px rgba(255,255,255,0.6)';
          const idx = lockIndex;
          setTimeout(() => {
            spans[idx].style.transition = 'text-shadow 0.5s ease';
            spans[idx].style.textShadow = 'none';
          }, 60);
          locked[lockIndex] = true;
          lockIndex++;
        }

        if (lockIndex >= target.length) {
          clearInterval(timer);

          setTimeout(() => {
            // measure real title position BEFORE showing page
            requestAnimationFrame(() => {
              const realRect = realTitle.getBoundingClientRect();
              const introRect = introEl.getBoundingClientRect();
              const dx = realRect.left - introRect.left;
              const dy = realRect.top - introRect.top;

              // fly to real title position
              introEl.style.transition = 'transform 0.85s cubic-bezier(0.16, 1, 0.3, 1)';
              introEl.style.transform = `translate(${dx}px, ${dy}px)`;

              setTimeout(() => {
                // NOW show page, make real title visible, hide overlay
                pageContent.classList.add('visible');
                titleBlock.style.opacity = '1';
                titleBlock.style.animation = 'none';
                realTitle.style.visibility = 'visible';
                overlay.style.display = 'none';
                subtitle.style.opacity = '1';
              }, 860);
            });
          }, 400);
        }
      }, 30);
    })();

    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
    }, { threshold: 0.15 });

    document.querySelectorAll('.context-card, .hiw-step, .seq-card, .hiw-section h2, .seq-section h2').forEach((el, i) => {
      el.style.transitionDelay = `${(i % 4) * 0.1}s`;
      observer.observe(el);
    });

    // ── THEME TOGGLE ──
    function toggleFullscreen() {
      const wrapper = document.querySelector('.canvas-wrapper');
      if (!document.fullscreenElement) {
        wrapper.requestFullscreen().catch(err => console.log(err));
      } else {
        document.exitFullscreen();
      }
    }

    function toggleTheme() {
      const isLight = document.documentElement.classList.toggle('light');
      localStorage.setItem('theme-pref', isLight ? 'light' : 'dark');
      const btn = document.getElementById('themeToggle');
      const finalText = isLight ? 'dark' : 'light';
      const numStart = isLight ? 4096 : 16384;
      const numEnd = isLight ? 16384 : 4096;
      const chars = 'abcdefghijklmnopqrstuvwxyz';
      btn.disabled = true;

      // Phase 1: number flicker (700ms, 20 steps)
      const numSteps = 20;
      const numDuration = 700;
      const numInterval = numDuration / numSteps;
      let numStep = 0;

      const numTimer = setInterval(() => {
        numStep++;
        const progress = numStep / numSteps;
        const current = Math.round(numStart + (numEnd - numStart) * progress);
        btn.textContent = current.toLocaleString();

        if (numStep >= numSteps) {
          clearInterval(numTimer);

          // Phase 2: letter scramble (900ms, 30 steps)
          const txtSteps = 30;
          const txtDuration = 900;
          const txtInterval = txtDuration / txtSteps;
          let txtStep = 0;

          const txtTimer = setInterval(() => {
            txtStep++;
            const progress = txtStep / txtSteps;
            let display = '';
            for (let i = 0; i < finalText.length; i++) {
              if (i < Math.floor(progress * finalText.length)) {
                display += finalText[i];
              } else {
                display += chars[Math.floor(Math.random() * chars.length)];
              }
            }
            btn.textContent = display;

            if (txtStep >= txtSteps) {
              clearInterval(txtTimer);
              btn.textContent = finalText;
              btn.disabled = false;
            }
          }, txtInterval);
        }
      }, numInterval);

      // swap the first swatch between white and dark
      const autoSwatch = document.getElementById('swatchAuto');
      const newColor = isLight ? '#1a1a1a' : '#ffffff';
      autoSwatch.style.background = newColor;
      autoSwatch.dataset.color = newColor;
      // if it's the active swatch, update curveColor too
      if (autoSwatch.classList.contains('active')) curveColor = newColor;
    }

    // restore saved theme on page load — default explicitly to dark
    (function initTheme() {
      const saved = localStorage.getItem('theme-pref');
      const btn = document.getElementById('themeToggle');
      const autoSwatch = document.getElementById('swatchAuto');
      if (saved === 'light') {
        document.documentElement.classList.add('light');
        btn.textContent = 'dark';
        autoSwatch.style.background = '#1a1a1a';
        autoSwatch.dataset.color = '#1a1a1a';
        curveColor = '#1a1a1a';
      } else {
        // default to dark mode and persist preference
        localStorage.setItem('theme-pref', 'dark');
        document.documentElement.classList.remove('light');
        btn.textContent = 'light';
        autoSwatch.style.background = '#ffffff';
        autoSwatch.dataset.color = '#ffffff';
        curveColor = '#ffffff';
      }
    })();

    // ── MODAL ──
    const MODAL_CONTENT = {
      about: {
        title: 'About',
        body: `
          <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
            <img src="https://avatars.githubusercontent.com/Jay061205" alt="Jay Rathod" style="width:72px;height:72px;border-radius:50%;border:1px solid var(--border);" onerror="this.style.display='none'"/>
            <div>
              <div style="font-family:'Caveat',cursive; font-size:26px; font-weight:700; color:var(--accent); font-style:normal;">Jay Rathod</div>
              <div style="display:flex; gap:14px; margin-top:8px; align-items:center;">
                <a href="https://github.com/Jay061205" target="_blank" style="color:var(--muted); display:flex; align-items:center; gap:5px; text-decoration:none; font-size:14px; transition:color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/></svg>
                  GitHub ↗
                </a>
                <a href="https://x.com/Jay_Rathod_06" target="_blank" style="color:var(--muted); display:flex; align-items:center; gap:5px; text-decoration:none; font-size:14px; transition:color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.748l7.73-8.835L1.254 2.25H8.08l4.253 5.622 5.91-5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                  Twitter ↗
                </a>
              </div>
            </div>
          </div>
          <p>Mathematisches is a creative exploration of what happens when number theory meets geometry. Feed a sequence of numbers through a simple binary parity rule — even bits go straight, odd bits turn left 60° — and watch fractal curves emerge from pure arithmetic.</p>
          <p style="margin-top:12px;">The project started as a curiosity: can the Koch snowflake be derived from bit counting alone? The answer, as it turns out, is yes — and the same rule applied to primes, Fibonacci numbers, and other sequences produces entirely different and equally beautiful curves.</p>
          <p style="margin-top:12px;">Built from scratch. Logic in Python first, then ported to the web.</p>
          <p style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
            <span style="color:var(--muted);">originally inspired by</span>
            <a href="https://www.instagram.com/reel/DTVXyKlDh0s/?utm_source=ig_web_copy_link&igsh=MzRlODBiNWFlZA==" target="_blank" style="color:var(--muted); margin-left:6px; text-decoration:none; transition:color 0.2s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">this reel ↗</a>
          </p>
        `
      },
      howItWorks: {
        title: 'How it works',
        body: `
          <p>Every number has a binary representation — a sequence of 1s and 0s. The number 5 is <em>101</em>, the number 7 is <em>111</em>, the number 12 is <em>1100</em>.</p>
          <p style="margin-top:12px;">For each number, count how many 1-bits it has. If that count is <strong style="color:var(--text); font-style:normal;">even</strong>, the command is <strong style="color:var(--text); font-style:normal;">F</strong> — step forward. If it's <strong style="color:var(--text); font-style:normal;">odd</strong>, the command is <strong style="color:var(--text); font-style:normal;">T</strong> — turn left 60°.</p>
          <p style="margin-top:12px;">So 0 → <em>0</em> ones → F. 1 → <em>1</em> one → T. 2 → <em>1</em> one → T. 3 → <em>2</em> ones → F. 4 → <em>1</em> one → T. And so on.</p>
          <p style="margin-top:12px;">This produces the sequence: F T T F T F F T T F F T... — which is the Thue-Morse sequence. A mathematical object discovered in 1906, it has a deep self-similar structure that encodes the 60° geometry of the Koch curve at every scale.</p>
          <p style="margin-top:12px;">Now imagine a turtle on a canvas. It reads the commands one by one. F means walk forward one step. T means spin left by 60°. After 65,536 commands — the complete Koch snowflake is drawn. No geometry. No recursion. Just bit counting.</p>
          <p style="margin-top:12px;">The same rule applied to different number sequences — primes, Fibonacci, evens, odds — produces entirely different curves. Same logic, different inputs, different universes.</p>
        `
      },
      sequences: {
        title: 'Sequences',
        body: `<p>Info coming soon.</p>`
      }
    };

    function openModal(key) {
      const content = MODAL_CONTENT[key];
      document.getElementById('modalTitle').textContent = content.title;
      document.getElementById('modalBody').innerHTML = content.body;
      document.getElementById('modalBackdrop').classList.add('open');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      document.getElementById('modalBackdrop').classList.remove('open');
      document.body.style.overflow = '';
    }

    // close on Escape key
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
  </script>
</body>

</html>